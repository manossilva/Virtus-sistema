<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtus | Gestão de Construção Completa</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d1d6; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aeaeb2; }

        .apple-card {
            background: white;
            border-radius: 18px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .apple-btn {
            background-color: #34c759;
            color: white;
            transition: transform 0.1s;
        }
        .apple-btn:active { transform: scale(0.98); }
        .apple-btn:hover { background-color: #2eb14d; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Animação de Atraso (Piscando) */
        @keyframes blink-red {
            0% { border-color: #ef4444; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { border-color: #fca5a5; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
            100% { border-color: #ef4444; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
        }
        .overdue-pulse {
            animation: blink-red 2s infinite;
            border: 2px solid #ef4444 !important;
        }

        /* Etiquetas de Setor */
        .sector-financeiro { background-color: #fee2e2; color: #991b1b; }
        .sector-engenharia { background-color: #e0f2fe; color: #075985; }
        .sector-marketing { background-color: #fce7f3; color: #9d174d; }
        .sector-atendimento { background-color: #fef3c7; color: #92400e; }
        .sector-ceo { background-color: #f3f4f6; color: #1f2937; }
        
        /* Layout de Impressão (Ficha do Cliente) */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; padding: 40px; }
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="app" class="flex h-full w-full"></div>

    <!-- MODAL GLOBAL -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all p-6 relative">
            <!-- Conteúdo dinâmico -->
        </div>
    </div>

    <!-- ÁREA DE IMPRESSÃO (Escondida na tela) -->
    <div id="print-area" class="hidden bg-white"></div>

    <script>
        // --- 1. DADOS E CONFIGURAÇÕES ---

        // Fases da Obra Minha Casa Minha Vida (22 Fases)
        const fasesObra = [
            "1. Simulação Crédito", "2. Doc. Pessoais", "3. Aprovação Crédito", "4. Assinatura Caixa", 
            "5. Alvará Prefeitura", "6. Projetos Eng/Arq", "7. Limpeza Terreno", "8. Locação/Gabarito", 
            "9. Fundação", "10. Impermeabilização", "11. Alvenaria", "12. Vergas/Contravergas", 
            "13. Laje/Cinta", "14. Telhado", "15. Hidráulica", "16. Elétrica", 
            "17. Reboco Interno", "18. Reboco Externo", "19. Contrapiso", "20. Revestimentos", 
            "21. Pintura/Acabam.", "22. Entrega Chaves"
        ];

        const usuarios = [
            { id: 1, nome: 'Roberto (CEO)', cargo: 'CEO' },
            { id: 2, nome: 'Ana (Finanças)', cargo: 'Financeiro' },
            { id: 3, nome: 'Eng. Carlos', cargo: 'Engenharia' },
            { id: 4, nome: 'Marcos (Mkt)', cargo: 'Marketing' }
        ];

        const setores = ['Financeiro', 'Engenharia', 'Marketing', 'Atendimento', 'CEO'];

        let state = {
            currentUser: null,
            tasks: [], // Demandas Internas
            clientes: [], // Base de Clientes
            obras: [], // Cards do Kanban de Obras
            financas: {
                saldo: 150000.00,
                transacoes: [ 
                    { id: 1, tipo: 'saida', desc: 'Cimento Votoran', valor: 5000, data: '2023-11-20', metodo: 'Boleto', entidade: 'Depósito São José', status: 'pago' },
                    { id: 2, tipo: 'entrada', desc: 'Entrada Casa Sr. João', valor: 25000, data: '2023-11-18', metodo: 'Pix', entidade: 'João Silva', status: 'recebido' }
                ]
            },
            agendaCEO: [],
            notificacoes: []
        };

        // --- 2. PERSISTÊNCIA ---

        function loadState() {
            const saved = localStorage.getItem('virtusState_v3');
            if (saved) {
                state = JSON.parse(saved);
            } else {
                // Seed inicial
                state.clientes.push({
                    id: 1, nome: 'João Silva', cpf: '123.456.789-00', nasc: '1985-05-20', 
                    endereco: 'Rua das Flores, 123', fotoDoc: 'cnh_joao.jpg', fachada: 'casa_moderna_1.jpg'
                });
                state.obras.push({
                    id: 101, clienteId: 1, fase: '9. Fundação', prazo: '2023-11-10' // Atrasado propositalmente
                });
                state.tasks.push({
                    id: 201, titulo: 'Aprovar Orçamento Mkt', setor: 'Marketing', responsavel: 'Roberto (CEO)', 
                    prazo: '2023-11-25', status: 'todo', desc: 'Aprovar verba para Facebook Ads', prioridade: 'alta'
                });
                saveState();
            }
        }

        function saveState() {
            localStorage.setItem('virtusState_v3', JSON.stringify(state));
            if(document.getElementById('app').innerHTML !== '') renderApp();
        }

        function init() { loadState(); renderApp(); }

        // --- 3. RENDERIZAÇÃO GERAL ---

        function renderApp() {
            const app = document.getElementById('app');
            if (!state.currentUser) {
                renderLogin(app);
            } else {
                renderDashboard(app);
                lucide.createIcons();
            }
        }

        function renderLogin(container) {
            container.innerHTML = `
                <div class="m-auto w-full max-w-md p-8 fade-in">
                    <div class="text-center mb-10">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-green-100 text-green-600 mb-4">
                            <i data-lucide="building-2" class="w-8 h-8"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900">Virtus Construct</h1>
                        <p class="text-gray-500">Sistema Integrado de Gestão</p>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                        <select id="loginSelect" class="w-full p-3 bg-gray-50 border rounded-xl mb-6">
                            ${usuarios.map(u => `<option value="${u.id}">${u.nome} - ${u.cargo}</option>`).join('')}
                        </select>
                        <button onclick="login(parseInt(document.getElementById('loginSelect').value))" class="w-full apple-btn py-3.5 rounded-xl font-medium shadow-lg shadow-green-500/30">Entrar</button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function login(id) {
            state.currentUser = usuarios.find(u => u.id === id);
            saveState();
        }
        function logout() {
            state.currentUser = null;
            saveState();
        }

        // --- DASHBOARD ---
        let currentPage = 'kanban_interno'; // Página inicial para demonstrar a mudança

        function renderDashboard(container) {
            const user = state.currentUser;
            const menuItems = [
                { id: 'kanban_obras', label: 'Obras MCMV', icon: 'hard-hat' },
                { id: 'kanban_interno', label: 'Demandas Internas', icon: 'trello' },
                { id: 'clientes', label: 'Base de Clientes', icon: 'users' },
                { id: 'financeiro', label: 'Financeiro', icon: 'wallet', restricted: true },
                { id: 'agenda', label: 'Agenda', icon: 'calendar' }
            ];

            const sidebar = `
                <nav class="w-64 bg-white border-r border-gray-200 flex flex-col p-6 hidden md:flex z-10">
                    <div class="flex items-center gap-3 mb-10 text-green-600">
                        <i data-lucide="hexagon" class="fill-current w-6 h-6"></i>
                        <span class="font-bold text-xl text-gray-800">Virtus</span>
                    </div>
                    <div class="space-y-1 flex-1">
                        ${menuItems.map(item => {
                            if (item.restricted && user.cargo !== 'CEO' && user.cargo !== 'Financeiro') return '';
                            return `
                            <button onclick="setPage('${item.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors ${currentPage === item.id ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}">
                                <i data-lucide="${item.icon}" class="w-5 h-5"></i> ${item.label}
                            </button>`;
                        }).join('')}
                    </div>
                    <div class="mt-auto pt-6 border-t border-gray-100">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600 text-xs">${user.nome.charAt(0)}</div>
                            <div class="text-sm"><p class="font-medium truncate w-32">${user.nome}</p><p class="text-xs text-gray-500">${user.cargo}</p></div>
                        </div>
                        <button onclick="logout()" class="text-red-500 text-xs font-medium hover:underline">Sair do sistema</button>
                    </div>
                </nav>
            `;

            const content = `
                <main class="flex-1 flex flex-col min-w-0 bg-[#f5f5f7] h-full">
                    <header class="h-16 px-8 flex items-center justify-between bg-white/50 backdrop-blur-md border-b border-gray-200 sticky top-0 z-20">
                        <h2 class="text-lg font-semibold text-gray-800 capitalize">${menuItems.find(i => i.id === currentPage)?.label || currentPage}</h2>
                        <div class="flex items-center gap-4">
                            <button class="p-2 rounded-full hover:bg-gray-100 relative">
                                <i data-lucide="bell" class="w-5 h-5 text-gray-600"></i>
                                ${state.notificacoes.some(n => !n.lida) ? '<span class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full"></span>' : ''}
                            </button>
                        </div>
                    </header>
                    <div class="flex-1 overflow-x-hidden overflow-y-auto p-6 relative">
                        ${getPageContent()}
                    </div>
                </main>
            `;
            container.innerHTML = sidebar + content;
        }

        function setPage(page) { currentPage = page; renderApp(); }

        function getPageContent() {
            switch(currentPage) {
                case 'kanban_obras': return renderObras();
                case 'kanban_interno': return renderKanbanInterno();
                case 'clientes': return renderClientes();
                case 'financeiro': return renderFinanceiro();
                case 'agenda': return renderAgenda();
                default: return '';
            }
        }

        // --- 4. KANBAN DE OBRAS (MCMV) ---
        function renderObras() {
            return `
                <div class="flex flex-col h-full">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">Acompanhamento de Obras</h3>
                            <p class="text-sm text-gray-500">Fluxo Minha Casa Minha Vida - 22 Fases</p>
                        </div>
                        <button onclick="openObraModal()" class="apple-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <i data-lucide="home" class="w-4 h-4"></i> Iniciar Nova Obra
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-x-auto overflow-y-hidden pb-4">
                        <div class="flex gap-4 h-full" style="width: max-content;">
                            ${fasesObra.map(fase => {
                                const obrasFase = state.obras.filter(o => o.fase === fase);
                                return `
                                <div class="w-72 flex-shrink-0 flex flex-col h-full rounded-xl bg-gray-100/60 border border-gray-200 p-2">
                                    <div class="px-2 py-2 mb-2 flex justify-between items-center border-b border-gray-200/50">
                                        <h4 class="font-semibold text-xs text-gray-600 uppercase tracking-wide truncate" title="${fase}">${fase}</h4>
                                        <span class="bg-white text-gray-500 text-[10px] px-1.5 py-0.5 rounded shadow-sm">${obrasFase.length}</span>
                                    </div>
                                    <div class="flex-1 overflow-y-auto space-y-2 p-1 custom-scrollbar" ondrop="dropObra(event, '${fase}')" ondragover="allowDrop(event)">
                                        ${obrasFase.map(obra => renderObraCard(obra)).join('')}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderObraCard(obra) {
            const cliente = state.clientes.find(c => c.id === obra.clienteId) || { nome: 'Desconhecido', fachada: null };
            const isOverdue = new Date(obra.prazo) < new Date();
            
            return `
                <div draggable="true" ondragstart="dragObra(event, ${obra.id})" 
                    class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 cursor-move hover:shadow-md transition-all group ${isOverdue ? 'overdue-pulse' : ''}">
                    ${cliente.fachada ? `<div class="h-24 w-full bg-gray-100 rounded-lg mb-2 bg-cover bg-center" style="background-image: url('https://source.unsplash.com/random/300x200/?house,construction')"></div>` : `<div class="h-24 w-full bg-gray-100 rounded-lg mb-2 flex items-center justify-center text-gray-400"><i data-lucide="home" class="w-8 h-8"></i></div>`}
                    <h5 class="font-semibold text-gray-800 text-sm leading-tight mb-1">${cliente.nome}</h5>
                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-50">
                        <div class="flex items-center gap-1 text-xs ${isOverdue ? 'text-red-600 font-bold' : 'text-gray-500'}">
                            <i data-lucide="calendar" class="w-3 h-3"></i>
                            ${obra.prazo.split('-').reverse().slice(0,2).join('/')}
                        </div>
                        ${isOverdue ? '<i data-lucide="alert-triangle" class="w-4 h-4 text-red-500"></i>' : ''}
                    </div>
                </div>
            `;
        }

        // --- 5. KANBAN INTERNO (DEMANDAS EQUIPE) ---
        
        function renderKanbanInterno() {
            const cols = [
                { id: 'todo', title: 'A Fazer', color: 'bg-gray-100' },
                { id: 'doing', title: 'Em Andamento', color: 'bg-blue-50' },
                { id: 'blocked', title: 'Travado / Pendência', color: 'bg-red-50' },
                { id: 'done', title: 'Concluído', color: 'bg-green-50' }
            ];

            return `
                <div class="flex flex-col h-full">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">Demandas Internas</h3>
                            <p class="text-gray-500 text-sm">Quadro de tarefas administrativas e operacionais</p>
                        </div>
                        <button onclick="openTaskModal()" class="apple-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Nova Tarefa
                        </button>
                    </div>

                    <div class="flex gap-4 h-full overflow-x-auto pb-4">
                        ${cols.map(col => `
                            <div class="w-80 flex-shrink-0 flex flex-col h-full rounded-xl ${col.color} border border-gray-200 p-3">
                                <div class="flex items-center justify-between mb-3 px-1">
                                    <h4 class="font-bold text-gray-700 text-sm uppercase tracking-wide">${col.title}</h4>
                                    <span class="bg-white/50 text-gray-600 text-xs px-2 py-1 rounded-md font-bold">${state.tasks.filter(t => t.status === col.id).length}</span>
                                </div>
                                <div class="flex-1 overflow-y-auto space-y-3 custom-scrollbar p-1" ondrop="dropTask(event, '${col.id}')" ondragover="allowDrop(event)">
                                    ${state.tasks.filter(t => t.status === col.id).map(task => renderTaskCard(task)).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderTaskCard(task) {
            const isOverdue = new Date(task.prazo) < new Date() && task.status !== 'done';
            const sectorColor = `sector-${task.setor.toLowerCase()}`;
            
            return `
                <div draggable="true" ondragstart="dragTask(event, ${task.id})" onclick="openTaskModal(${task.id})"
                    class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-all group relative ${isOverdue ? 'overdue-pulse' : ''}">
                    
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] uppercase font-bold px-2 py-1 rounded-md ${sectorColor}">${task.setor}</span>
                    </div>
                    
                    <h5 class="font-semibold text-gray-800 text-sm mb-1 leading-snug">${task.titulo}</h5>
                    <p class="text-xs text-gray-500 mb-3 line-clamp-2">${task.desc}</p>
                    
                    <div class="pt-3 border-t border-gray-100 flex justify-between items-center">
                        <div class="flex items-center gap-1.5 text-xs text-gray-500">
                            <div class="w-5 h-5 rounded-full bg-gray-100 flex items-center justify-center font-bold text-[10px] text-gray-600" title="${task.responsavel}">
                                ${task.responsavel.charAt(0)}
                            </div>
                            <span class="truncate w-16">${task.responsavel.split(' ')[0]}</span>
                        </div>
                        <div class="flex items-center gap-1 text-xs ${isOverdue ? 'text-red-600 font-bold' : 'text-gray-400'}">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            ${task.prazo.split('-').reverse().slice(0,2).join('/')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- 6. MÓDULO DE CLIENTES ---
        function renderClientes() {
            return `
                <div class="max-w-6xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Base de Clientes</h3>
                        <button onclick="openClienteModal()" class="apple-btn px-4 py-2 rounded-lg text-sm font-medium shadow-md shadow-green-500/20">
                            + Novo Cliente
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.clientes.map(cli => `
                            <div class="apple-card p-5 flex flex-col gap-4">
                                <div class="flex items-start gap-4">
                                    <div class="w-16 h-16 rounded-full bg-gray-200 flex-shrink-0 bg-cover bg-center" 
                                        style="background-image: url('https://ui-avatars.com/api/?name=${cli.nome}&background=random')"></div>
                                    <div>
                                        <h4 class="font-bold text-gray-900">${cli.nome}</h4>
                                        <p class="text-xs text-gray-500 font-mono mt-1">CPF: ${cli.cpf}</p>
                                        <p class="text-xs text-gray-500 truncate w-40">${cli.endereco}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-auto">
                                    <button onclick="generatePDF(${cli.id})" class="flex-1 py-2 bg-gray-100 text-gray-700 text-xs font-medium rounded-lg hover:bg-gray-200 flex items-center justify-center gap-2">
                                        <i data-lucide="printer" class="w-3 h-3"></i> Ficha PDF
                                    </button>
                                    <button onclick="editCliente(${cli.id})" class="px-3 py-2 bg-blue-50 text-blue-600 text-xs font-medium rounded-lg hover:bg-blue-100">
                                        Editar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- 7. FINANCEIRO ---
        function renderFinanceiro() {
            const saldo = state.financas.saldo;
            const receitas = state.financas.transacoes.filter(t => t.tipo === 'entrada').reduce((a,b) => a + b.valor, 0);
            const despesas = state.financas.transacoes.filter(t => t.tipo === 'saida').reduce((a,b) => a + b.valor, 0);

            return `
                <div class="max-w-5xl mx-auto space-y-8 fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="apple-card p-6">
                            <span class="text-sm text-gray-500 font-medium block mb-2">Saldo em Caixa</span>
                            <span class="text-3xl font-bold text-gray-900">R$ ${saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="apple-card p-6 border-l-4 border-green-500">
                            <span class="text-sm text-gray-500 font-medium block mb-2">Receitas (Mês)</span>
                            <span class="text-2xl font-bold text-green-600">+ R$ ${receitas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="apple-card p-6 border-l-4 border-red-500">
                            <span class="text-sm text-gray-500 font-medium block mb-2">Despesas (Mês)</span>
                            <span class="text-2xl font-bold text-red-600">- R$ ${despesas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-5 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-semibold text-gray-800">Histórico de Transações</h3>
                            <button onclick="openTransacaoModal()" class="text-sm text-green-600 font-bold hover:underline">+ Nova Transação</button>
                        </div>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-6 py-3">Data</th>
                                    <th class="px-6 py-3">Descrição</th>
                                    <th class="px-6 py-3">Entidade</th>
                                    <th class="px-6 py-3">Método</th>
                                    <th class="px-6 py-3 text-right">Valor</th>
                                    <th class="px-6 py-3 text-center">Tipo</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${state.financas.transacoes.map(t => `
                                    <tr class="hover:bg-gray-50/50">
                                        <td class="px-6 py-4 text-gray-500">${t.data.split('-').reverse().join('/')}</td>
                                        <td class="px-6 py-4 font-medium text-gray-900">${t.desc}</td>
                                        <td class="px-6 py-4 text-gray-600">${t.entidade}</td>
                                        <td class="px-6 py-4 text-gray-500 text-xs uppercase">${t.metodo}</td>
                                        <td class="px-6 py-4 text-right font-mono ${t.tipo === 'entrada' ? 'text-green-600' : 'text-red-600'}">
                                            R$ ${t.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${t.tipo === 'entrada' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                                ${t.tipo}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- AGENDA ---
        function renderAgenda() {
            return `
                <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-sm">
                    <h3 class="text-xl font-bold mb-4">Agenda Colaborativa</h3>
                    <div class="space-y-4">
                        ${state.agendaCEO.map(evt => `
                            <div class="flex gap-4 p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <div class="text-green-600 font-bold text-center w-12 text-sm leading-tight">${evt.data.split('-').reverse().slice(0,2).join('<br>')}</div>
                                <div class="flex-1 font-medium text-gray-800">${evt.evento}</div>
                            </div>
                        `).join('') || '<p class="text-gray-400">Nenhum evento agendado.</p>'}
                        <button onclick="promptAddEvent()" class="w-full py-3 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 hover:border-green-400 hover:text-green-600 transition-colors">+ Adicionar Evento</button>
                    </div>
                </div>`;
        }

        // --- 8. MODAIS E LÓGICA DE SALVAMENTO ---

        function openModal(html) {
            const content = document.getElementById('modal-content');
            const overlay = document.getElementById('modal-overlay');
            content.innerHTML = `
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                ${html}
            `;
            overlay.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }

        // Modal Tarefa Interna
        function openTaskModal(taskId = null) {
            const task = taskId ? state.tasks.find(t => t.id === taskId) : null;
            openModal(`
                <h2 class="text-xl font-bold mb-6">${task ? 'Editar' : 'Nova'} Tarefa</h2>
                <form onsubmit="saveTask(event, ${taskId})" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Título</label>
                        <input type="text" name="titulo" value="${task?.titulo || ''}" required class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Setor</label>
                            <select name="setor" class="w-full p-2 border rounded-lg bg-white">
                                ${setores.map(s => `<option ${task?.setor === s ? 'selected' : ''} value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Responsável</label>
                            <select name="responsavel" class="w-full p-2 border rounded-lg bg-white">
                                ${usuarios.map(u => `<option ${task?.responsavel === u.nome ? 'selected' : ''} value="${u.nome}">${u.nome}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Prazo</label>
                        <input type="date" name="prazo" value="${task?.prazo || ''}" required class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição</label>
                        <textarea name="desc" class="w-full p-2 border rounded-lg" rows="3">${task?.desc || ''}</textarea>
                    </div>
                    <button type="submit" class="w-full apple-btn py-3 rounded-xl font-bold mt-4">Salvar Tarefa</button>
                    ${task ? `<button type="button" onclick="deleteTask(${taskId})" class="w-full text-red-500 text-sm mt-2 hover:underline">Excluir Tarefa</button>` : ''}
                </form>
            `);
        }

        function saveTask(e, id) {
            e.preventDefault();
            const f = e.target;
            const data = {
                titulo: f.titulo.value,
                setor: f.setor.value,
                responsavel: f.responsavel.value,
                prazo: f.prazo.value,
                desc: f.desc.value
            };

            if(id) {
                const idx = state.tasks.findIndex(t => t.id === id);
                state.tasks[idx] = { ...state.tasks[idx], ...data };
            } else {
                state.tasks.push({
                    id: Date.now(),
                    status: 'todo',
                    ...data
                });
            }
            saveState();
            closeModal();
        }

        function deleteTask(id) {
            if(confirm("Tem certeza que deseja excluir esta tarefa?")) {
                state.tasks = state.tasks.filter(t => t.id !== id);
                saveState();
                closeModal();
            }
        }

        // Modal Transação (Financeiro)
        function openTransacaoModal() {
            openModal(`
                <h2 class="text-xl font-bold mb-6">Nova Movimentação</h2>
                <form onsubmit="saveTransacao(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo</label>
                            <select name="tipo" class="w-full p-2 border rounded-lg bg-gray-50">
                                <option value="saida">Pagamento (Despesa)</option>
                                <option value="entrada">Recebimento (Receita)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data</label>
                            <input type="date" name="data" required class="w-full p-2 border rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição</label>
                        <input type="text" name="desc" placeholder="Ex: Pagamento Fornecedor X" required class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor (R$)</label>
                            <input type="number" step="0.01" name="valor" required class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Método</label>
                            <select name="metodo" class="w-full p-2 border rounded-lg bg-gray-50">
                                <option>Boleto</option>
                                <option>Pix</option>
                                <option>Transferência</option>
                                <option>Dinheiro</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Quem Pagou/Recebeu</label>
                        <input type="text" name="entidade" placeholder="Nome do Cliente ou Fornecedor" required class="w-full p-2 border rounded-lg">
                    </div>
                    <button type="submit" class="w-full apple-btn py-3 rounded-xl font-bold mt-4">Confirmar Transação</button>
                </form>
            `);
        }

        function saveTransacao(e) {
            e.preventDefault();
            const f = e.target;
            const val = parseFloat(f.valor.value);
            const tipo = f.tipo.value;
            
            state.financas.transacoes.push({
                id: Date.now(),
                tipo,
                data: f.data.value,
                desc: f.desc.value,
                valor: val,
                metodo: f.metodo.value,
                entidade: f.entidade.value,
                status: 'efetivado'
            });

            if(tipo === 'entrada') state.financas.saldo += val;
            else state.financas.saldo -= val;

            saveState();
            closeModal();
        }

        // Modal Cliente
        function openClienteModal(clienteId = null) {
            const cli = clienteId ? state.clientes.find(c => c.id === clienteId) : null;
            openModal(`
                <h2 class="text-xl font-bold mb-6">${cli ? 'Editar' : 'Novo'} Cliente</h2>
                <form onsubmit="saveCliente(event, ${clienteId})" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome Completo</label>
                        <input type="text" name="nome" value="${cli?.nome || ''}" required class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">CPF</label>
                            <input type="text" name="cpf" value="${cli?.cpf || ''}" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nascimento</label>
                            <input type="date" name="nasc" value="${cli?.nasc || ''}" class="w-full p-2 border rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Endereço</label>
                        <input type="text" name="endereco" value="${cli?.endereco || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-green-500">
                            <i data-lucide="image" class="w-6 h-6 mx-auto text-gray-400"></i>
                            <span class="text-xs text-gray-500 block mt-1">Foto Documento</span>
                        </div>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-green-500">
                            <i data-lucide="home" class="w-6 h-6 mx-auto text-gray-400"></i>
                            <span class="text-xs text-gray-500 block mt-1">Fachada Casa</span>
                        </div>
                    </div>
                    <button type="submit" class="w-full apple-btn py-3 rounded-xl font-bold mt-4">Salvar Dados</button>
                </form>
            `);
        }

        function saveCliente(e, id) {
            e.preventDefault();
            const f = e.target;
            const dados = {
                nome: f.nome.value,
                cpf: f.cpf.value,
                nasc: f.nasc.value,
                endereco: f.endereco.value,
                fotoDoc: 'doc_simulado.jpg', // Simulado
                fachada: 'fachada_simulada.jpg' // Simulado
            };

            if(id) {
                const idx = state.clientes.findIndex(c => c.id === id);
                state.clientes[idx] = { ...state.clientes[idx], ...dados };
            } else {
                state.clientes.push({ id: Date.now(), ...dados });
            }
            saveState();
            closeModal();
        }

        // Modal Nova Obra
        function openObraModal() {
            if(state.clientes.length === 0) return alert("Cadastre clientes primeiro!");
            openModal(`
                <h2 class="text-xl font-bold mb-6">Iniciar Nova Obra MCMV</h2>
                <form onsubmit="saveObra(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cliente</label>
                        <select name="clienteId" class="w-full p-3 border rounded-lg bg-white">
                            ${state.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Prazo Fase 1</label>
                        <input type="date" name="prazo" required class="w-full p-3 border rounded-lg">
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                        A obra iniciará na fase: <strong>1. Simulação Crédito</strong>. Os dados do cliente serão vinculados automaticamente.
                    </div>
                    <button type="submit" class="w-full apple-btn py-3 rounded-xl font-bold mt-4">Criar Card de Obra</button>
                </form>
            `);
        }

        function saveObra(e) {
            e.preventDefault();
            state.obras.push({
                id: Date.now(),
                clienteId: parseInt(e.target.clienteId.value),
                fase: fasesObra[0],
                prazo: e.target.prazo.value
            });
            saveState();
            closeModal();
        }

        // --- 9. PDF GENERATOR ---
        function generatePDF(clienteId) {
            const cli = state.clientes.find(c => c.id === clienteId);
            const printArea = document.getElementById('print-area');
            
            printArea.innerHTML = `
                <div style="font-family: Arial, sans-serif; max-width: 210mm; margin: 0 auto;">
                    <div style="border-bottom: 2px solid #333; padding-bottom: 20px; mb-6 display: flex; justify-content: space-between; align-items: center;">
                        <h1 style="font-size: 24px; color: #1d8f2d;">Ficha Cadastral do Cliente</h1>
                        <span>Virtus Construct System</span>
                    </div>
                    <div style="display: flex; gap: 20px; margin-top: 30px;">
                        <div style="width: 150px; height: 150px; background: #eee; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center;">Foto Cliente</div>
                        <div style="flex: 1;">
                            <p><strong>Nome Completo:</strong> ${cli.nome}</p>
                            <p><strong>CPF:</strong> ${cli.cpf}</p>
                            <p><strong>Data Nasc:</strong> ${cli.nasc.split('-').reverse().join('/')}</p>
                            <p><strong>Endereço Obra:</strong> ${cli.endereco}</p>
                        </div>
                    </div>
                    <h2 style="margin-top: 40px; border-bottom: 1px solid #ccc; font-size: 18px;">Fachada Escolhida</h2>
                    <div style="margin-top: 20px; height: 300px; background: #f9f9f9; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center;">Imagem da Fachada</div>
                    <div style="margin-top: 50px; text-align: center; font-size: 12px; color: #666;">Gerado via Sistema Virtus em ${new Date().toLocaleDateString()}</div>
                </div>
            `;
            window.print();
            setTimeout(() => { printArea.innerHTML = ''; }, 1000);
        }

        // --- 10. DRAG AND DROP LÓGICA ---
        function allowDrop(ev) { ev.preventDefault(); }
        
        // Drag Obras
        function dragObra(ev, id) { ev.dataTransfer.setData("type", "obra"); ev.dataTransfer.setData("id", id); }
        function dropObra(ev, faseDestino) {
            ev.preventDefault();
            if(ev.dataTransfer.getData("type") !== "obra") return;
            const id = parseInt(ev.dataTransfer.getData("id"));
            const idx = state.obras.findIndex(o => o.id === id);
            if (idx > -1) { state.obras[idx].fase = faseDestino; saveState(); }
        }

        // Drag Tasks (Interno)
        function dragTask(ev, id) { ev.dataTransfer.setData("type", "task"); ev.dataTransfer.setData("id", id); }
        function dropTask(ev, statusDestino) {
            ev.preventDefault();
            if(ev.dataTransfer.getData("type") !== "task") return;
            const id = parseInt(ev.dataTransfer.getData("id"));
            const idx = state.tasks.findIndex(t => t.id === id);
            if (idx > -1) { state.tasks[idx].status = statusDestino; saveState(); }
        }

        function promptAddEvent() {
            const txt = prompt("Evento:");
            if(txt) {
                state.agendaCEO.push({ id: Date.now(), data: new Date().toISOString().split('T')[0], evento: txt });
                saveState();
            }
        }

        init();
    </script>
</body>
</html>